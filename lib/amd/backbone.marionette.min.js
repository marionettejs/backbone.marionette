// Backbone.Marionette v0.9.3
//
// Copyright (C)2012 Derick Bailey, Muted Solutions, LLC
// Distributed Under MIT License
//
// Documentation and Full License Available at:
// http://github.com/derickbailey/backbone.marionette

(function(e,t){if(typeof exports=="object"){var n=require("jquery"),r=require("underscore"),i=require("backbone");module.exports=t(n,r,i)}else typeof define=="function"&&define.amd&&define(["jquery","underscore","backbone"],t)})(this,function(e,t,n){return n.Marionette=function(e,t,n){var r={};r.BindTo={bindTo:function(e,t,n,r){r=r||this,e.on(t,n,r),this.bindings||(this.bindings=[]);var i={obj:e,eventName:t,callback:n,context:r};return this.bindings.push(i),i},unbindFrom:function(e){e.obj.off(e.eventName,e.callback,e.context),this.bindings=t.reject(this.bindings,function(t){return t===e})},unbindAll:function(){var e=this,n=t.map(this.bindings,t.identity);t.each(n,function(t,n){e.unbindFrom(t)})}},r.View=e.View.extend({constructor:function(){e.View.prototype.constructor.apply(this,arguments),this.bindTo(this,"show",this.onShowCalled,this)},getTemplate:function(){var e;return this.options&&this.options.template?e=this.options.template:e=this.template,e},serializeData:function(){var e;return this.model?e=this.model.toJSON():this.collection&&(e={items:this.collection.toJSON()}),e=this.mixinTemplateHelpers(e),e},mixinTemplateHelpers:function(e){e=e||{};var n=this.templateHelpers;return t.isFunction(n)&&(n=n.call(this)),t.extend(e,n)},configureTriggers:function(){if(!this.triggers)return;var e=this.triggers,n=this,r={};return t.isFunction(e)&&(e=e.call(this)),t.each(e,function(e,t){r[t]=function(t){t&&t.preventDefault&&t.preventDefault(),t&&t.stopPropagation&&t.stopPropagation(),n.trigger(e)}}),r},delegateEvents:function(n){n=n||this.events,t.isFunction(n)&&(n=n.call(this));var r={},i=this.configureTriggers();t.extend(r,n,i),e.View.prototype.delegateEvents.call(this,r)},onShowCalled:function(){},close:function(){this.beforeClose&&this.beforeClose(),this.remove(),this.onClose&&this.onClose(),this.trigger("close"),this.unbindAll(),this.unbind()},bindUIElements:function(){if(!this.ui)return;var e=this;this.uiBindings||(this.uiBindings=this.ui),this.ui={},t.each(t.keys(this.uiBindings),function(t){var n=e.uiBindings[t];e.ui[t]=e.$(n)})}}),t.extend(r.View.prototype,r.BindTo),r.ItemView=r.View.extend({constructor:function(){r.View.prototype.constructor.apply(this,arguments),this.initialEvents()},initialEvents:function(){this.collection&&this.bindTo(this.collection,"reset",this.render,this)},render:function(){this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this);var e=this.serializeData(),t=this.getTemplate(),n=r.Renderer.render(t,e);return this.$el.html(n),this.bindUIElements(),this.onRender&&this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this),this},close:function(){this.trigger("item:before:close"),r.View.prototype.close.apply(this,arguments),this.trigger("item:closed")}}),r.CollectionView=r.View.extend({constructor:function(){r.View.prototype.constructor.apply(this,arguments),this.initChildViewStorage(),this.initialEvents(),this.onShowCallbacks=new r.Callbacks},initialEvents:function(){this.collection&&(this.bindTo(this.collection,"add",this.addChildView,this),this.bindTo(this.collection,"remove",this.removeItemView,this),this.bindTo(this.collection,"reset",this.render,this))},addChildView:function(e,t,n){this.closeEmptyView();var r=this.getItemView();return this.addItemView(e,r,n.index)},onShowCalled:function(){this.onShowCallbacks.run()},triggerBeforeRender:function(){this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("collection:before:render",this)},triggerRendered:function(){this.onRender&&this.onRender(),this.trigger("render",this),this.trigger("collection:rendered",this)},render:function(){return this.triggerBeforeRender(),this.closeChildren(),this.collection&&this.collection.length>0?this.showCollection():this.showEmptyView(),this.triggerRendered(),this},showCollection:function(){var e=this,t=this.getItemView();this.collection.each(function(n,r){e.addItemView(n,t,r)})},showEmptyView:function(){var t=this.options.emptyView||this.emptyView;if(t){this.showingEmptyView=!0;var n=new e.Model;this.addItemView(n,t,0)}},closeEmptyView:function(){this.showingEmptyView&&(this.closeChildren(),delete this.showingEmptyView)},getItemView:function(){var e=this.options.itemView||this.itemView;if(!e){var t=new Error("An `itemView` must be specified");throw t.name="NoItemViewError",t}return e},addItemView:function(e,t,n){var r=this,s=this.buildItemView(e,t);this.storeChild(s),this.onItemAdded&&this.onItemAdded(s),this.trigger("item:added",s);var o=this.renderItemView(s,n);s.onShow&&this.onShowCallbacks.add(s.onShow,s);var u=this.bindTo(s,"all",function(){var e=i.call(arguments);e[0]="itemview:"+e[0],e.splice(1,0,s),r.trigger.apply(r,e)});return this.childBindings=this.childBindings||{},this.childBindings[s.cid]=u,o},renderItemView:function(e,t){e.render(),this.appendHtml(this,e,t)},buildItemView:function(e,n){var r=t.result(this,"itemViewOptions"),i=t.extend({model:e},r),s=new n(i);return s},removeItemView:function(e){var t=this.children[e.cid];if(t){var n=this.childBindings[t.cid];n&&(this.unbindFrom(n),delete this.childBindings[t.cid]),t.close(),delete this.children[e.cid]}this.collection.length===0&&this.showEmptyView(),this.trigger("item:removed",t)},appendHtml:function(e,t,n){e.$el.append(t.el)},storeChild:function(e){this.children[e.model.cid]=e},initChildViewStorage:function(){this.children={}},close:function(){this.trigger("collection:before:close"),this.closeChildren(),r.View.prototype.close.apply(this,arguments),this.trigger("collection:closed")},closeChildren:function(){var e=this;this.children&&t.each(t.clone(this.children),function(t){e.removeItemView(t.model)})}}),r.CompositeView=r.CollectionView.extend({constructor:function(e){r.CollectionView.apply(this,arguments),this.itemView=this.getItemView()},initialEvents:function(){this.collection&&(this.bindTo(this.collection,"add",this.addChildView,this),this.bindTo(this.collection,"remove",this.removeItemView,this),this.bindTo(this.collection,"reset",this.renderCollection,this))},getItemView:function(){return this.itemView||this.constructor},render:function(){var e=this;this.resetItemViewContainer();var t=this.renderModel();return this.$el.html(t),this.bindUIElements(),this.trigger("composite:model:rendered"),this.trigger("render"),this.renderCollection(),this.trigger("composite:rendered"),this},renderCollection:function(){r.CollectionView.prototype.render.apply(this,arguments),this.trigger("composite:collection:rendered")},renderModel:function(){var e={};e=this.serializeData();var t=this.getTemplate();return r.Renderer.render(t,e)},appendHtml:function(e,t){var n=this.getItemViewContainer(e);n.append(t.el)},getItemViewContainer:function(e){var n;return"$itemViewContainer"in e?n=e.$itemViewContainer:(e.itemViewContainer?n=e.$(t.result(e,"itemViewContainer")):n=e.$el,e.$itemViewContainer=n),n},resetItemViewContainer:function(){this.$itemViewContainer&&delete this.$itemViewContainer}}),r.Region=function(e){this.options=e||{},t.extend(this,e);if(!this.el){var n=new Error("An 'el' must be specified");throw n.name="NoElError",n}this.initialize&&this.initialize.apply(this,arguments)},t.extend(r.Region.prototype,e.Events,{show:function(e){var t=this;this.ensureEl(),this.close(),e.render(),this.open(e),e.onShow&&e.onShow(),e.trigger("show"),this.onShow&&this.onShow(e),this.trigger("view:show",e),this.currentView=e},ensureEl:function(){if(!this.$el||this.$el.length===0)this.$el=this.getEl(this.el)},getEl:function(e){return n(e)},open:function(e){this.$el.html(e.el)},close:function(){var e=this.currentView;if(!e)return;e.close&&e.close(),this.trigger("view:closed",e),delete this.currentView},attachView:function(e){this.currentView=e}}),r.Region.extend=e.View.extend,t.extend(r.Region.prototype,r.BindTo),r.Layout=r.ItemView.extend({constructor:function(){e.Marionette.ItemView.apply(this,arguments),this.initializeRegions()},render:function(){var e=r.ItemView.prototype.render.apply(this,arguments);return this.render=function(){this.closeRegions(),this.reInitializeRegions();var e=r.ItemView.prototype.render.apply(this,arguments);return e},e},close:function(){this.closeRegions(),this.destroyRegions(),e.Marionette.ItemView.prototype.close.call(this,arguments)},initializeRegions:function(){this.regionManagers||(this.regionManagers={});var n=this;t.each(this.regions,function(t,r){var i=new e.Marionette.Region({el:t,getEl:function(e){return n.$(e)}});n.regionManagers[r]=i,n[r]=i})},reInitializeRegions:function(){t.each(this.regionManagers,function(e){delete e.$el})},closeRegions:function(){var e=this;t.each(this.regionManagers,function(e,t){e.close()})},destroyRegions:function(){var e=this;t.each(this.regionManagers,function(t,n){delete e[n]}),this.regionManagers={}}}),r.Application=function(e){this.initCallbacks=new r.Callbacks,this.vent=new r.EventAggregator,t.extend(this,e)},t.extend(r.Application.prototype,e.Events,{addInitializer:function(e){this.initCallbacks.add(e)},start:function(e){this.trigger("initialize:before",e),this.initCallbacks.run(e,this),this.trigger("initialize:after",e),this.trigger("start",e)},addRegions:function(e){var t,n,i;for(i in e)e.hasOwnProperty(i)&&(t=e[i],typeof t=="string"?n=new r.Region({el:t}):n=new t,this[i]=n)},module:function(){return r.Module.create.apply(this,arguments)}}),r.Application.extend=e.View.extend,t.extend(r.Application.prototype,r.BindTo),r.AppRouter=e.Router.extend({constructor:function(t){e.Router.prototype.constructor.call(this,t);if(this.appRoutes){var n=this.controller;t&&t.controller&&(n=t.controller),this.processAppRoutes(n,this.appRoutes)}},processAppRoutes:function(e,n){var r,i,s,o,u,a=[],f=this;for(s in n)n.hasOwnProperty(s)&&a.unshift([s,n[s]]);o=a.length;for(u=0;u<o;u++){s=a[u][0],i=a[u][1],r=e[i];if(!r){var l="Method '"+i+"' was not found on the controller",c=new Error(l);throw c.name="NoMethodError",c}r=t.bind(r,e),f.route(s,i,r)}}}),r.Module=function(){},t.extend(r.Module.prototype,e.Events,r.BindTo),t.extend(r.Module,{create:function(n,s){var o,u,a,f=this,l=this,n=n.split("."),c=n.length;for(var h=0;h<c;h++){var p=h===c-1;o=n[h],u=l[o],u||(u=new r.Module);if(p&&s){var d=i.apply(arguments);d.shift(),d.shift();var v=[u,f,e,r,jQuery,t,d],m=t.flatten(v);s.apply(u,m)}l[o]!==u&&(l[o]=u),l=u}return u}}),r.TemplateCache=function(e){this.templateId=e},t.extend(r.TemplateCache,{templateCaches:{},get:function(e){var t=this,n=this.templateCaches[e];return n||(n=new r.TemplateCache(e),this.templateCaches[e]=n),n.load()},clear:function(){var e,t=arguments.length;if(t>0)for(e=0;e<t;e++)delete this.templateCaches[arguments[e]];else this.templateCaches={}}}),t.extend(r.TemplateCache.prototype,{load:function(){var e=this;if(this.compiledTemplate)return this.compiledTemplate;var t=this.loadTemplate(this.templateId);return this.compiledTemplate=this.compileTemplate(t),this.compiledTemplate},loadTemplate:function(e){var t=n(e).html();if(!t||t.length===0){var r="Could not find template: '"+e+"'",i=new Error(r);throw i.name="NoTemplateError",i}return t},compileTemplate:function(e){return t.template(e)}}),r.Renderer={render:function(e,t){var n=r.TemplateCache.get(e),i=n(t);return i}},r.Callbacks=function(){this.deferred=n.Deferred(),this.promise=this.deferred.promise()},t.extend(r.Callbacks.prototype,{add:function(e,t){this.promise.done(function(n,r){t&&(n=t),e.call(n,r)})},run:function(e,t){this.deferred.resolve(t,e)}}),r.EventAggregator=function(e){t.extend(this,e)},t.extend(r.EventAggregator.prototype,e.Events,r.BindTo,{bindTo:function(e,t,n){return r.BindTo.bindTo.call(this,this,e,t,n)}});var i=Array.prototype.slice;return r}(n,t,window.jQuery||window.Zepto||window.ender),n.Marionette})