// Backbone.Marionette v0.9.0-pre
//
// Copyright (C)2012 Derick Bailey, Muted Solutions, LLC
// Distributed Under MIT License
//
// Documentation and Full License Available at:
// http://github.com/derickbailey/backbone.marionette

Backbone.Marionette.Async=function(Backbone,Marionette,_,$){var Async={init:function(){Marionette.TemplateCache=Async.TemplateCache,Marionette.Renderer=Async.Renderer,_.extend(Marionette.ItemView.prototype,Async.ItemView),_.extend(Marionette.CollectionView.prototype,Async.CollectionView),_.extend(Marionette.CompositeView.prototype,Async.CompositeView),_.extend(Marionette.Region.prototype,Async.Region)}};Async.ItemView={render:function(){var that=this,deferredRender=$.Deferred(),beforeRenderDone=function(){that.trigger("before:render",that),that.trigger("item:before:render",that);var deferredData=that.serializeData();$.when(deferredData).then(dataSerialized)},dataSerialized=function(data){var template=that.getTemplate(),asyncRender=Marionette.Renderer.render(template,data);$.when(asyncRender).then(templateRendered)},templateRendered=function(html){that.$el.html(html),callDeferredMethod(that.onRender,onRenderDone,that)},onRenderDone=function(){that.trigger("render",that),that.trigger("item:rendered",that),deferredRender.resolve()};return callDeferredMethod(this.beforeRender,beforeRenderDone,this),deferredRender.promise()}},Async.CollectionView={render:function(){var that=this,deferredRender=$.Deferred(),promises=[],ItemView=this.getItemView(),EmptyView=this.options.emptyView||this.emptyView;this.beforeRender&&this.beforeRender(),this.trigger("collection:before:render",this),this.closeChildren();if(this.collection)if(this.collection.length===0&&EmptyView){var promise=this.addItemView(new Backbone.Model,EmptyView);promises.push(promise)}else this.collection.each(function(item){var promise=that.addItemView(item,ItemView);promises.push(promise)});return deferredRender.done(function(){this.onRender&&this.onRender(),this.trigger("collection:rendered",this)}),$.when.apply(this,promises).then(function(){deferredRender.resolveWith(that)}),deferredRender.promise()},renderItemView:function(view){var that=this,viewRendered=view.render();return $.when(viewRendered).then(function(){that.appendHtml(that,view)}),viewRendered}},Async.CompositeView={render:function(){var that=this,compositeRendered=$.Deferred(),modelIsRendered=this.renderModel();return $.when(modelIsRendered).then(function(html){that.$el.html(html),that.trigger("composite:model:rendered"),that.trigger("render");var collectionIsRendered=that.renderCollection();$.when(collectionIsRendered).then(function(){compositeRendered.resolve()})}),compositeRendered.done(function(){that.trigger("composite:rendered")}),compositeRendered.promise()},renderCollection:function(){var collectionDeferred=Marionette.CollectionView.prototype.render.apply(this,arguments);return collectionDeferred.done(function(){this.trigger("composite:collection:rendered")}),collectionDeferred.promise()}},Async.Region={show:function(view){var that=this;this.ensureEl(),this.close(),$.when(view.render()).then(function(){that.open(view),view.onShow&&view.onShow(),view.trigger("show"),that.onShow&&that.onShow(view),that.trigger("view:show",view)}),this.currentView=view}},Async.Renderer={render:function(template,data){var asyncRender=$.Deferred(),templateRetrieval=Marionette.TemplateCache.get(template);return $.when(templateRetrieval).then(function(templateFunc){var html=templateFunc(data);asyncRender.resolve(html)}),asyncRender.promise()}},Async.TemplateCache=function(templateId){this.templateId=templateId},_.extend(Async.TemplateCache,{templateCaches:{},get:function(templateId){var that=this,cachedTemplate=this.templateCaches[templateId];return cachedTemplate||(cachedTemplate=new Marionette.TemplateCache(templateId),this.templateCaches[templateId]=cachedTemplate),cachedTemplate.load()},clear:function(){var i,length=arguments.length;if(length>0)for(i=0;i<length;i++)delete this.templateCaches[arguments[i]];else this.templateCaches={}}}),_.extend(Async.TemplateCache.prototype,{load:function(){var that=this;return this.deferred?this.deferred.promise():(this.deferred=$.Deferred(),this.loadTemplate(this.templateId,function(template){that.template=template,that.deferred.resolve(template)}),this.deferred.promise())},loadTemplate:function(templateId,callback){var template=$(templateId).html();if(!template||template.length===0){var msg="Could not find template: '"+templateId+"'",err=new Error(msg);throw err.name="NoTemplateError",err}template=this.compileTemplate(template),callback.call(this,template)},compileTemplate:function(rawTemplate){return _.template(rawTemplate)}});var callDeferredMethod=function(fn,callback,context){var promise;fn&&(promise=fn.call(context)),$.when(promise).then(_.bind(callback,context))};return Async.init(),Async}(Backbone,Backbone.Marionette,_,window.jQuery||window.Zepto||window.ender)