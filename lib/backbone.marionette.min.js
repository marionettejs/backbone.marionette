// Backbone.Marionette, v1.0.0-beta1
// Copyright (c)2012 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
// http://github.com/marionettejs/backbone.marionette
Backbone.Marionette=Marionette=function(a,b,c){var d={},e=Array.prototype.slice;return d.extend=a.Model.extend,d.triggerMethod=function(){var a=Array.prototype.slice.apply(arguments),c=a[0],d=c.split(":"),e,f,g="on";for(var h=0;h<d.length;h++)e=d[h],f=e.charAt(0).toUpperCase(),g+=f+e.slice(1);this.trigger.apply(this,arguments),b.isFunction(this[g])&&(a.shift(),this[g].apply(this,a))},d.EventBinder=a.EventBinder,d.addEventBinder=function(a){var c=new d.EventBinder;a.eventBinder=c,a.bindTo=b.bind(c.bindTo,c),a.unbindFrom=b.bind(c.unbindFrom,c),a.unbindAll=b.bind(c.unbindAll,c)},d.View=a.View.extend({constructor:function(){b.bindAll(this,"render"),d.addEventBinder(this),a.View.prototype.constructor.apply(this,arguments),this.bindBackboneEntityTo(this.model,this.modelEvents),this.bindBackboneEntityTo(this.collection,this.collectionEvents),this.bindTo(this,"show",this.onShowCalled,this)},triggerMethod:d.triggerMethod,getTemplate:function(){var a;return this.options&&this.options.template?a=this.options.template:a=this.template,a},mixinTemplateHelpers:function(a){a=a||{};var c=this.templateHelpers;return b.isFunction(c)&&(c=c.call(this)),b.extend(a,c)},configureTriggers:function(){if(!this.triggers)return;var a=this.triggers,c=this,d={};return b.isFunction(a)&&(a=a.call(this)),b.each(a,function(a,b){d[b]=function(b){b&&b.preventDefault&&b.preventDefault(),b&&b.stopPropagation&&b.stopPropagation(),c.trigger(a)}}),d},delegateEvents:function(c){c=c||this.events,b.isFunction(c)&&(c=c.call(this));var d={},e=this.configureTriggers();b.extend(d,c,e),a.View.prototype.delegateEvents.call(this,d)},onShowCalled:function(){},close:function(){if(this.isClosed)return;this.triggerMethod("before:close"),this.remove(),this.unbindAll(),this.triggerMethod("close"),this.isClosed=!0},bindUIElements:function(){if(!this.ui)return;var a=this;this.uiBindings||(this.uiBindings=this.ui),this.ui={},b.each(b.keys(this.uiBindings),function(b){var c=a.uiBindings[b];a.ui[b]=a.$(c)})},bindBackboneEntityTo:function(a,c){if(!a||!c)return;var d=this;b.each(c,function(b,c){var e=d[b];if(!e)throw new Error("View method '"+b+"' was configured as an event handler, but does not exist.");d.bindTo(a,c,e,d)})}}),d.ItemView=d.View.extend({constructor:function(){d.View.prototype.constructor.apply(this,arguments),this.initialEvents&&this.initialEvents()},serializeData:function(){var a;return this.model?a=this.model.toJSON():this.collection&&(a={items:this.collection.toJSON()}),a=this.mixinTemplateHelpers(a),a},render:function(){this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this);var a=this.serializeData(),b=this.getTemplate(),c=d.Renderer.render(b,a);return this.$el.html(c),this.bindUIElements(),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},close:function(){if(this.isClosed)return;this.triggerMethod("item:before:close"),d.View.prototype.close.apply(this,arguments),this.triggerMethod("item:closed")}}),d.CollectionView=d.View.extend({constructor:function(){this.initChildViewStorage(),d.View.prototype.constructor.apply(this,arguments),this.initialEvents(),this.onShowCallbacks=new d.Callbacks},initialEvents:function(){this.collection&&(this.bindTo(this.collection,"add",this.addChildView,this),this.bindTo(this.collection,"remove",this.removeItemView,this),this.bindTo(this.collection,"reset",this.render,this))},addChildView:function(a,b,c){this.closeEmptyView();var d=this.getItemView(a),e;return c&&c.index?e=c.index:e=0,this.addItemView(a,d,e)},onShowCalled:function(){this.onShowCallbacks.run()},triggerBeforeRender:function(){this.triggerMethod("before:render",this),this.triggerMethod("collection:before:render",this)},triggerRendered:function(){this.triggerMethod("render",this),this.triggerMethod("collection:rendered",this)},render:function(){return this.isClosed=!1,this.triggerBeforeRender(),this.closeEmptyView(),this.closeChildren(),this.collection&&this.collection.length>0?this.showCollection():this.showEmptyView(),this.triggerRendered(),this},showCollection:function(){var a=this,b;this.collection.each(function(c,d){b=a.getItemView(c),a.addItemView(c,b,d)})},showEmptyView:function(){var b=this.options.emptyView||this.emptyView;if(b&&!this._showingEmptyView){this._showingEmptyView=!0;var c=new a.Model;this.addItemView(c,b,0)}},closeEmptyView:function(){this._showingEmptyView&&(this.closeChildren(),delete this._showingEmptyView)},getItemView:function(a){var b=this.options.itemView||this.itemView;if(!b){var c=new Error("An `itemView` must be specified");throw c.name="NoItemViewError",c}return b},addItemView:function(a,b,c){var d=this,f=this.buildItemView(a,b);this.storeChild(f),this.triggerMethod("item:added",f);var g=this.renderItemView(f,c);f.onShow&&this.onShowCallbacks.add(f.onShow,f);var h=this.bindTo(f,"all",function(){var a=e.call(arguments);a[0]="itemview:"+a[0],a.splice(1,0,f),d.triggerMethod.apply(d,a)});return this.childBindings=this.childBindings||{},this.childBindings[f.cid]=h,g},renderItemView:function(a,b){a.render(),this.appendHtml(this,a,b)},buildItemView:function(a,c){var d;b.isFunction(this.itemViewOptions)?d=this.itemViewOptions(a):d=this.itemViewOptions;var e=b.extend({model:a},d),f=new c(e);return f},removeItemView:function(a){var b=this.children[a.cid];if(b){var c=this.childBindings[b.cid];c&&(this.unbindFrom(c),delete this.childBindings[b.cid]),b.close(),delete this.children[a.cid]}(!this.collection||this.collection.length===0)&&this.showEmptyView(),this.triggerMethod("item:removed",b)},appendHtml:function(a,b,c){a.$el.append(b.el)},storeChild:function(a){this.children[a.model.cid]=a},initChildViewStorage:function(){this.children={}},close:function(){if(this.isClosed)return;this.triggerMethod("collection:before:close"),this.closeChildren(),this.triggerMethod("collection:closed"),d.View.prototype.close.apply(this,arguments)},closeChildren:function(){var a=this;this.children&&b.each(b.clone(this.children),function(b){a.removeItemView(b.model)})}}),d.CompositeView=d.CollectionView.extend({constructor:function(a){d.CollectionView.apply(this,arguments),this.itemView=this.getItemView()},initialEvents:function(){this.collection&&(this.bindTo(this.collection,"add",this.addChildView,this),this.bindTo(this.collection,"remove",this.removeItemView,this),this.bindTo(this.collection,"reset",this.renderCollection,this))},getItemView:function(a){var b=this.options.itemView||this.itemView||this.constructor;if(!b){var c=new Error("An `itemView` must be specified");throw c.name="NoItemViewError",c}return b},serializeData:function(){var a={};return this.model&&(a=this.model.toJSON()),a=this.mixinTemplateHelpers(a),a},render:function(){this.isClosed=!1,this.resetItemViewContainer();var a=this.renderModel();return this.$el.html(a),this.bindUIElements(),this.triggerMethod("composite:model:rendered"),this.triggerMethod("render"),this.renderCollection(),this.triggerMethod("composite:rendered"),this},renderCollection:function(){d.CollectionView.prototype.render.apply(this,arguments),this.triggerMethod("composite:collection:rendered")},renderModel:function(){var a={};a=this.serializeData();var b=this.getTemplate();return d.Renderer.render(b,a)},appendHtml:function(a,b){var c=this.getItemViewContainer(a);c.append(b.el)},getItemViewContainer:function(a){if("$itemViewContainer"in a)return a.$itemViewContainer;var c;if(a.itemViewContainer){var d=b.result(a,"itemViewContainer");c=a.$(d);if(c.length<=0){var e=new Error("The specified `itemViewContainer` was not found: "+a.itemViewContainer);throw e.name="ItemViewContainerMissingError",e}}else c=a.$el;return a.$itemViewContainer=c,c},resetItemViewContainer:function(){this.$itemViewContainer&&delete this.$itemViewContainer}}),d.Region=function(a){this.options=a||{};var b=this.options.el;delete this.options.el,d.addEventBinder(this),b&&(this.el=b);if(!this.el){var c=new Error("An 'el' must be specified for a region.");throw c.name="NoElError",c}this.initialize&&this.initialize.apply(this,arguments)},b.extend(d.Region,{buildRegion:function(a,b){var c=typeof a=="string",d=typeof a.selector=="string",e=typeof a.regionType=="undefined",f=typeof a=="function";if(!f&&!c&&!d)throw new Error("Region must be specified as a Region type, a selector string or an object with selector property");var g,h;c&&(g=a),a.selector&&(g=a.selector),f&&(h=a),!f&&e&&(h=b),a.regionType&&(h=a.regionType);var i=new h({el:g});return i}}),b.extend(d.Region.prototype,a.Events,{show:function(a){this.ensureEl(),this.close(),a.render(),this.open(a),a.onShow&&a.onShow(),a.trigger("show"),this.onShow&&this.onShow(a),this.trigger("view:show",a),this.currentView=a},ensureEl:function(){if(!this.$el||this.$el.length===0)this.$el=this.getEl(this.el)},getEl:function(a){return c(a)},open:function(a){this.$el.html(a.el)},close:function(){var a=this.currentView;if(!a||a.isClosed)return;a.close&&a.close(),this.trigger("view:closed",a),delete this.currentView},attachView:function(a){this.currentView=a},reset:function(){this.close(),delete this.$el}}),d.Region.extend=d.extend,d.Layout=d.ItemView.extend({regionType:d.Region,constructor:function(){this.initializeRegions(),a.Marionette.ItemView.apply(this,arguments)},render:function(){this._firstRender?this._firstRender=!1:(this.closeRegions(),this.reInitializeRegions());var a=d.ItemView.prototype.render.apply(this,arguments);return a},close:function(){if(this.isClosed)return;this.closeRegions(),this.destroyRegions(),a.Marionette.ItemView.prototype.close.call(this,arguments)},initializeRegions:function(){this.regionManagers||(this.regionManagers={});var a=this,c=this.regions||{};b.each(c,function(b,c){var e=d.Region.buildRegion(b,a.regionType);e.getEl=function(b){return a.$(b)},a.regionManagers[c]=e,a[c]=e})},reInitializeRegions:function(){this.regionManagers&&b.size(this.regionManagers)===0?this.initializeRegions():b.each(this.regionManagers,function(a){a.reset()})},closeRegions:function(){var a=this;b.each(this.regionManagers,function(a,b){a.close()})},destroyRegions:function(){var a=this;b.each(this.regionManagers,function(b,c){delete a[c]}),this.regionManagers={}}}),d.Application=function(c){this.initCallbacks=new d.Callbacks,this.vent=new d.EventAggregator,this.commands=new a.Wreqr.Commands,this.reqres=new a.Wreqr.RequestResponse,this.submodules={},b.extend(this,c),d.addEventBinder(this)},b.extend(d.Application.prototype,a.Events,{execute:function(){this.commands.execute.apply(this.commands,arguments)},request:function(){return this.reqres.request.apply(this.reqres,arguments)},addInitializer:function(a){this.initCallbacks.add(a)},start:function(a){this.trigger("initialize:before",a),this.initCallbacks.run(a,this),this.trigger("initialize:after",a),this.trigger("start",a)},addRegions:function(a){var c=this;b.each(a,function(a,b){var e=d.Region.buildRegion(a,d.Region);c[b]=e})},removeRegion:function(a){this[a].close(),delete this[a]},module:function(a,b){var c=e.call(arguments);return c.unshift(this),d.Module.create.apply(d.Module,c)}}),d.Application.extend=d.extend,d.AppRouter=a.Router.extend({constructor:function(b){a.Router.prototype.constructor.call(this,b);if(this.appRoutes){var c=this.controller;b&&b.controller&&(c=b.controller),this.processAppRoutes(c,this.appRoutes)}},processAppRoutes:function(a,c){var d,e,f,g,h,i=[],j=this;for(f in c)c.hasOwnProperty(f)&&i.unshift([f,c[f]]);g=i.length;for(h=0;h<g;h++){f=i[h][0],e=i[h][1],d=a[e];if(!d){var k="Method '"+e+"' was not found on the controller",l=new Error(k);throw l.name="NoMethodError",l}d=b.bind(d,a),j.route(f,e,d)}}}),d.Module=function(a,b){this.moduleName=a,this.submodules={},this._setupInitializersAndFinalizers(),this.config={},this.config.app=b,d.addEventBinder(this)},b.extend(d.Module.prototype,a.Events,{addInitializer:function(a){this._initializerCallbacks.add(a)},addFinalizer:function(a){this._finalizerCallbacks.add(a)},start:function(a){if(this._isInitialized)return;b.each(this.submodules,function(b){b.config.options.startWithParent&&b.start(a)}),this._initializerCallbacks.run(a,this),this._isInitialized=!0},stop:function(){if(!this._isInitialized)return;this._isInitialized=!1,b.each(this.submodules,function(a){a.stop()}),this._finalizerCallbacks.run(),this._initializerCallbacks.reset(),this._finalizerCallbacks.reset()},addDefinition:function(a,b){this._runModuleDefinition(a,b)},_runModuleDefinition:function(e,f){if(!e)return;var g=b.flatten([this,this.config.app,a,d,c,b,f]);e.apply(this,g)},_setupInitializersAndFinalizers:function(){this._initializerCallbacks=new d.Callbacks,this._finalizerCallbacks=new d.Callbacks}}),b.extend(d.Module,{create:function(a,c,d){var f=this,g=a;c=c.split(".");var h=e.apply(arguments);h.splice(0,3);var i=c.length;return b.each(c,function(b,c){var e=c===i-1,j=f._getModuleDefinition(g,b,a);j.config.options=f._getModuleOptions(g,d),e&&f._configureAutoStart(a,j),e&&j.config.options.hasDefinition&&j.addDefinition(j.config.options.definition,h),g=j}),g},_configureAutoStart:function(a,b){b.config.options.startWithParent&&!b.config.autoStartConfigured&&a.addInitializer(function(a){b.start(a)}),b.config.autoStartConfigured=!0},_getModuleDefinition:function(a,b,c){var e=a[b];return e||(e=new d.Module(b,c),a[b]=e,a.submodules[b]=e),e},_getModuleOptions:function(a,c){var d={startWithParent:!0,hasDefinition:!!c};return d.hasDefinition?(b.isFunction(c)?d.definition=c:(d.hasDefinition=!!c.define,d.definition=c.define,c.hasOwnProperty("startWithParent")&&(d.startWithParent=c.startWithParent)),d):d}}),d.TemplateCache=function(a){this.templateId=a},b.extend(d.TemplateCache,{templateCaches:{},get:function(a){var b=this,c=this.templateCaches[a];return c||(c=new d.TemplateCache(a),this.templateCaches[a]=c),c.load()},clear:function(){var a,b=arguments.length;if(b>0)for(a=0;a<b;a++)delete this.templateCaches[arguments[a]];else this.templateCaches={}}}),b.extend(d.TemplateCache.prototype,{load:function(){var a=this;if(this.compiledTemplate)return this.compiledTemplate;var b=this.loadTemplate(this.templateId);return this.compiledTemplate=this.compileTemplate(b),this.compiledTemplate},loadTemplate:function(a){var b=c(a).html();if(!b||b.length===0){var d="Could not find template: '"+a+"'",e=new Error(d);throw e.name="NoTemplateError",e}return b},compileTemplate:function(a){return b.template(a)}}),d.Renderer={render:function(a,b){var c=typeof a=="function"?a:d.TemplateCache.get(a),e=c(b);return e}},d.Callbacks=function(){this._deferred=c.Deferred(),this._callbacks=[]},b.extend(d.Callbacks.prototype,{add:function(a,b){this._callbacks.push({cb:a,ctx:b}),this._deferred.done(function(c,d){b&&(c=b),a.call(c,d)})},run:function(a,b){this._deferred.resolve(b,a)},reset:function(){var a=this,d=this._callbacks;this._deferred=c.Deferred(),this._callbacks=[],b.each(d,function(b){a.add(b.cb,b.ctx)})}}),d.EventAggregator=a.Wreqr.EventAggregator,d}(Backbone,_,$||window.jQuery||window.Zepto||window.ender);