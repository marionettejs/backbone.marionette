// Backbone.Marionette v0.9.0-pre
//
// Copyright (C)2012 Derick Bailey, Muted Solutions, LLC
// Distributed Under MIT License
//
// Documentation and Full License Available at:
// http://github.com/derickbailey/backbone.marionette

Backbone.Marionette=function(Backbone,_,$){var Marionette={};Marionette.BindTo={bindTo:function(obj,eventName,callback,context){context=context||this,obj.on(eventName,callback,context),this.bindings||(this.bindings=[]);var binding={obj:obj,eventName:eventName,callback:callback,context:context};return this.bindings.push(binding),binding},unbindFrom:function(binding){binding.obj.off(binding.eventName,binding.callback,binding.context),this.bindings=_.reject(this.bindings,function(bind){return bind===binding})},unbindAll:function(){var that=this,bindings=_.map(this.bindings,_.identity);_.each(bindings,function(binding,index){that.unbindFrom(binding)})}},Marionette.View=Backbone.View.extend({constructor:function(){Backbone.View.prototype.constructor.apply(this,arguments),this.bindTo(this,"show",this.onShowCalled,this)},getTemplate:function(){var template;return this.options&&this.options.template?template=this.options.template:template=this.template,template},serializeData:function(){var data;return this.model?data=this.model.toJSON():this.collection&&(data={items:this.collection.toJSON()}),data=this.mixinTemplateHelpers(data),data},mixinTemplateHelpers:function(target){target=target||{};var templateHelpers=this.templateHelpers;return _.isFunction(templateHelpers)&&(templateHelpers=templateHelpers.call(this)),_.extend(target,templateHelpers)},configureTriggers:function(){if(!this.triggers)return;var triggers=this.triggers,that=this,triggerEvents={};return _.isFunction(triggers)&&(triggers=triggers.call(this)),_.each(triggers,function(value,key){triggerEvents[key]=function(e){e&&e.preventDefault&&e.preventDefault(),e&&e.stopPropagation&&e.stopPropagation(),that.trigger(value)}}),triggerEvents},delegateEvents:function(events){events=events||this.events,_.isFunction(events)&&(events=events.call(this));var combinedEvents={},triggers=this.configureTriggers();_.extend(combinedEvents,events,triggers),Backbone.View.prototype.delegateEvents.call(this,combinedEvents)},onShowCalled:function(){},close:function(){this.beforeClose&&this.beforeClose(),this.remove(),this.onClose&&this.onClose(),this.trigger("close"),this.unbindAll(),this.unbind()}}),_.extend(Marionette.View.prototype,Marionette.BindTo),Marionette.ItemView=Marionette.View.extend({constructor:function(){Marionette.View.prototype.constructor.apply(this,arguments),this.initialEvents()},initialEvents:function(){this.collection&&this.bindTo(this.collection,"reset",this.render,this)},render:function(){this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this);var data=this.serializeData(),template=this.getTemplate(),html=Marionette.Renderer.render(template,data);this.$el.html(html),this.onRender&&this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this)},close:function(){this.trigger("item:before:close"),Marionette.View.prototype.close.apply(this,arguments),this.trigger("item:closed")}}),Marionette.CollectionView=Marionette.View.extend({constructor:function(){Marionette.View.prototype.constructor.apply(this,arguments),this.initChildViewStorage(),this.initialEvents(),this.onShowCallbacks=new Marionette.Callbacks},initialEvents:function(){this.collection&&(this.bindTo(this.collection,"add",this.addChildView,this),this.bindTo(this.collection,"remove",this.removeItemView,this),this.bindTo(this.collection,"reset",this.render,this))},addChildView:function(item){var ItemView=this.getItemView();return this.addItemView(item,ItemView)},onShowCalled:function(){this.onShowCallbacks.run()},render:function(){var that=this,ItemView=this.getItemView(),EmptyView=this.options.emptyView||this.emptyView;this.beforeRender&&this.beforeRender(),this.trigger("collection:before:render",this),this.closeChildren(),this.collection&&(this.collection.length===0&&EmptyView?this.addItemView(new Backbone.Model,EmptyView):this.collection.each(function(item){that.addItemView(item,ItemView)})),this.onRender&&this.onRender(),this.trigger("collection:rendered",this)},getItemView:function(){var itemView=this.options.itemView||this.itemView;if(!itemView){var err=new Error("An `itemView` must be specified");throw err.name="NoItemViewError",err}return itemView},addItemView:function(item,ItemView){var that=this,view=this.buildItemView(item,ItemView);this.storeChild(view),this.onItemAdded&&this.onItemAdded(view),this.trigger("item:added",view);var renderResult=this.renderItemView(view);view.onShow&&this.onShowCallbacks.add(view.onShow,view);var childBinding=this.bindTo(view,"all",function(){var args=slice.call(arguments);args[0]="itemview:"+args[0],args.splice(1,0,view),that.trigger.apply(that,args)});return this.childBindings=this.childBindings||{},this.childBindings[view.cid]=childBinding,renderResult},renderItemView:function(view){view.render(),this.appendHtml(this,view)},buildItemView:function(item,ItemView){var itemViewOptions=_.result(this,"itemViewOptions"),options=_.extend({model:item},itemViewOptions),view=new ItemView(options);return view},removeItemView:function(item){var view=this.children[item.cid];if(view){var childBinding=this.childBindings[view.cid];childBinding&&(this.unbindFrom(childBinding),delete this.childBindings[view.cid]),view.close(),delete this.children[item.cid]}this.trigger("item:removed",view)},appendHtml:function(collectionView,itemView){collectionView.$el.append(itemView.el)},storeChild:function(view){this.children[view.model.cid]=view},initChildViewStorage:function(){this.children={}},close:function(){this.trigger("collection:before:close"),this.closeChildren(),Marionette.View.prototype.close.apply(this,arguments),this.trigger("collection:closed")},closeChildren:function(){var that=this;this.children&&_.each(_.clone(this.children),function(childView){that.removeItemView(childView.model)})}}),Marionette.CompositeView=Marionette.CollectionView.extend({constructor:function(options){Marionette.CollectionView.apply(this,arguments),this.itemView=this.getItemView()},initialEvents:function(){this.collection&&(this.bindTo(this.collection,"add",this.addChildView,this),this.bindTo(this.collection,"remove",this.removeItemView,this),this.bindTo(this.collection,"reset",this.renderCollection,this))},getItemView:function(){return this.itemView||this.constructor},render:function(){var that=this,html=this.renderModel();this.$el.html(html),this.trigger("composite:model:rendered"),this.trigger("render"),this.renderCollection(),this.trigger("composite:rendered")},renderCollection:function(){Marionette.CollectionView.prototype.render.apply(this,arguments),this.trigger("composite:collection:rendered")},renderModel:function(){var data={};data=this.serializeData();var template=this.getTemplate();return Marionette.Renderer.render(template,data)}}),Marionette.Region=function(options){this.options=options||{},_.extend(this,options);if(!this.el){var err=new Error("An 'el' must be specified");throw err.name="NoElError",err}this.initialize&&this.initialize.apply(this,arguments)},_.extend(Marionette.Region.prototype,Backbone.Events,{show:function(view){var that=this;this.ensureEl(),this.close(),view.render(),this.open(view),view.onShow&&view.onShow(),view.trigger("show"),this.onShow&&this.onShow(view),this.trigger("view:show",view),this.currentView=view},ensureEl:function(){if(!this.$el||this.$el.length===0)this.$el=this.getEl(this.el)},getEl:function(selector){return $(selector)},open:function(view){this.$el.html(view.el)},close:function(){var view=this.currentView;if(!view)return;view.close&&view.close(),this.trigger("view:closed",view),delete this.currentView},attachView:function(view){this.currentView=view}}),Marionette.Region.extend=Backbone.View.extend,_.extend(Marionette.Region.prototype,Marionette.BindTo),Marionette.Layout=Marionette.ItemView.extend({constructor:function(){Backbone.Marionette.ItemView.apply(this,arguments),this.initializeRegions()},render:function(){var result=Marionette.ItemView.prototype.render.apply(this,arguments);return this.render=function(){this.closeRegions(),this.reInitializeRegions();var result=Marionette.ItemView.prototype.render.apply(this,arguments);return result},result},close:function(){this.closeRegions(),this.destroyRegions(),Backbone.Marionette.ItemView.prototype.close.call(this,arguments)},initializeRegions:function(){this.regionManagers||(this.regionManagers={});var that=this;_.each(this.regions,function(selector,name){var regionManager=new Backbone.Marionette.Region({el:selector,getEl:function(selector){return that.$(selector)}});that.regionManagers[name]=regionManager,that[name]=regionManager})},reInitializeRegions:function(){_.each(this.regionManagers,function(region){delete region.$el})},closeRegions:function(){var that=this;_.each(this.regionManagers,function(manager,name){manager.close()})},destroyRegions:function(){var that=this;_.each(this.regionManagers,function(manager,name){delete that[name]}),this.regionManagers={}}}),Marionette.Application=function(options){this.initCallbacks=new Marionette.Callbacks,this.vent=new Marionette.EventAggregator,_.extend(this,options)},_.extend(Marionette.Application.prototype,Backbone.Events,{addInitializer:function(initializer){this.initCallbacks.add(initializer)},start:function(options){this.trigger("initialize:before",options),this.initCallbacks.run(options,this),this.trigger("initialize:after",options),this.trigger("start",options)},addRegions:function(regions){var regionValue,regionObj,region;for(region in regions)regions.hasOwnProperty(region)&&(regionValue=regions[region],typeof regionValue=="string"?regionObj=new Marionette.Region({el:regionValue}):regionObj=new regionValue,this[region]=regionObj)},module:function(){return Marionette.Module.create.apply(this,arguments)}}),Marionette.Application.extend=Backbone.View.extend,_.extend(Marionette.Application.prototype,Marionette.BindTo),Marionette.AppRouter=Backbone.Router.extend({constructor:function(options){Backbone.Router.prototype.constructor.call(this,options);if(this.appRoutes){var controller=this.controller;options&&options.controller&&(controller=options.controller),this.processAppRoutes(controller,this.appRoutes)}},processAppRoutes:function(controller,appRoutes){var method,methodName,route,routesLength,i,routes=[],router=this;for(route in appRoutes)appRoutes.hasOwnProperty(route)&&routes.unshift([route,appRoutes[route]]);routesLength=routes.length;for(i=0;i<routesLength;i++){route=routes[i][0],methodName=routes[i][1],method=controller[methodName];if(!method){var msg="Method '"+methodName+"' was not found on the controller",err=new Error(msg);throw err.name="NoMethodError",err}method=_.bind(method,controller),router.route(route,methodName,method)}}}),Marionette.Module=function(){},_.extend(Marionette.Module.prototype,Backbone.Events,Marionette.BindTo),_.extend(Marionette.Module,{create:function(moduleNames,moduleDefinition){var moduleName,module,moduleOverride,parentObject=this,parentModule=this,moduleNames=moduleNames.split("."),length=moduleNames.length;for(var i=0;i<length;i++){var isLastModuleInChain=i===length-1;moduleName=moduleNames[i],module=parentModule[moduleName],module||(module=new Marionette.Module);if(isLastModuleInChain&&moduleDefinition){var customArgs=slice.apply(arguments);customArgs.shift(),customArgs.shift();var argsArray=[module,parentObject,Backbone,Marionette,jQuery,_,customArgs],args=_.flatten(argsArray);moduleDefinition.apply(module,args)}parentModule[moduleName]!==module&&(parentModule[moduleName]=module),parentModule=module}return module}}),Marionette.TemplateCache=function(templateId){this.templateId=templateId},_.extend(Marionette.TemplateCache,{templateCaches:{},get:function(templateId){var that=this,cachedTemplate=this.templateCaches[templateId];return cachedTemplate||(cachedTemplate=new Marionette.TemplateCache(templateId),this.templateCaches[templateId]=cachedTemplate),cachedTemplate.load()},clear:function(){var i,length=arguments.length;if(length>0)for(i=0;i<length;i++)delete this.templateCaches[arguments[i]];else this.templateCaches={}}}),_.extend(Marionette.TemplateCache.prototype,{load:function(){var that=this;if(this.compiledTemplate)return this.compiledTemplate;var template=this.loadTemplate(this.templateId);return this.compiledTemplate=this.compileTemplate(template),this.compiledTemplate},loadTemplate:function(templateId){var template=$(templateId).html();if(!template||template.length===0){var msg="Could not find template: '"+templateId+"'",err=new Error(msg);throw err.name="NoTemplateError",err}return template},compileTemplate:function(rawTemplate){return _.template(rawTemplate)}}),Marionette.Renderer={render:function(template,data){var templateFunc=Marionette.TemplateCache.get(template),html=templateFunc(data);return html}},Marionette.Callbacks=function(){this.deferred=$.Deferred(),this.promise=this.deferred.promise()},_.extend(Marionette.Callbacks.prototype,{add:function(callback,contextOverride){this.promise.done(function(context,options){contextOverride&&(context=contextOverride),callback.call(context,options)})},run:function(options,context){this.deferred.resolve(context,options)}}),Marionette.EventAggregator=function(options){_.extend(this,options)},_.extend(Marionette.EventAggregator.prototype,Backbone.Events,Marionette.BindTo,{bindTo:function(eventName,callback,context){return Marionette.BindTo.bindTo.call(this,this,eventName,callback,context)}});var slice=Array.prototype.slice;return Marionette}(Backbone,_,window.jQuery||window.Zepto||window.ender)